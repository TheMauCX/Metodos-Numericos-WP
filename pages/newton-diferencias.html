<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diferencias Divididas de Newton - M√©todos Num√©ricos</title>
    
    <style>
        /* Estilos base (simplificados para que funcione por s√≠ solo) */
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --error-color: #dc3545;
            --light-bg: #f8f9fa;
            --text-primary: #212529;
            --text-secondary: #6c757d;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: var(--text-primary);
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        .page-container { padding: 30px; }
        .page-title {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }
        .subtitle { color: var(--text-secondary); margin-top: -10px; }
        .section-title {
            color: var(--text-primary);
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            margin-top: 25px;
        }
        .form-section {
            background: #fafbff;
            border-radius: 8px;
            padding: 25px;
            border: 1px solid #e0e0e0;
        }
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box; /* Importante para que el padding no rompa el ancho */
        }
        .input-help {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
        }
        .btn {
            padding: 12px 20px;
            font-size: 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            text-align: center;
            display: inline-block;
            margin: 5px 2px;
        }
        .btn-block { width: 100%; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-warning { background-color: var(--warning-color); color: black; }
        .btn-danger { background-color: var(--error-color); color: white; }
        .btn-small {
            padding: 8px 12px;
            font-size: 0.85rem;
        }
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            color: white;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .alert-success { background-color: var(--success-color); }
        .alert-info { background-color: #17a2b8; }
        .alert-warning { background-color: var(--warning-color); color: black; }
        .alert-error { background-color: var(--error-color); }
        
        .results-section {
            margin-top: 20px;
            display: block;
        }
        .result-card, .result-summary {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        /* Estilos espec√≠ficos de esta p√°gina */
        .point-input-row {
            display: grid;
            grid-template-columns: 1fr 1fr 50px;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }
        .polynomial-display {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            line-height: 1.8;
            overflow-x: auto;
        }
        .simplified-poly {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
            padding: 25px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            line-height: 1.8;
            overflow-x: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        .newton-form {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: #212529;
            padding: 25px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            line-height: 2;
            overflow-x: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .differences-table {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            overflow-x: auto;
            border: 1px solid #e0e0e0;
        }
        .differences-table table {
            width: 100%;
            border-collapse: collapse;
        }
        .differences-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px;
            text-align: center;
            font-size: 0.9rem;
        }
        .differences-table td {
            padding: 10px;
            text-align: center;
            border: 1px solid #dee2e6;
            font-family: 'Courier New', monospace;
        }
        .differences-table tr:nth-child(even) {
            background-color: #ffffff;
        }
        .diagonal-highlight {
            background-color: #fff3cd !important;
            font-weight: bold;
            color: #664d03;
        }
        .evaluation-section {
            background: #e6f7ff;
            border: 1px solid #b3e0ff;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .point-badge {
            display: inline-block;
            background: var(--secondary-color);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 5px;
            font-size: 0.9rem;
        }
        .coefficient-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 8px 15px;
            border-radius: 15px;
            margin: 5px;
            font-size: 1rem;
            font-family: 'Courier New', monospace;
        }
        .table-container { overflow-x: auto; }
        .table-container table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .table-container th, .table-container td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .table-container th {
            background-color: #f2f2f2;
        }
        .back-button {
            display: inline-block;
            margin-bottom: 20px;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <a href="#" class="back-button" onclick="window.history.back(); return false;">‚Üê Volver</a>
    
    <div class="container">
        <div class="page-container">
            <h1 class="page-title">Diferencias Divididas de Newton</h1>
            <p class="subtitle">Interpolaci√≥n polin√≥mica usando el m√©todo progresivo de Newton</p>

            <div class="form-section">
                <h2 class="section-title">M√©todo de Entrada de Datos</h2>
                
                <div class="form-group">
                    <label for="inputMethod">Seleccione el m√©todo de entrada:</label>
                    <select id="inputMethod" onchange="toggleInputMethod()">
                        <option value="manual">Entrada manual de puntos</option>
                        <option value="function">Generar desde una funci√≥n</option>
                    </select>
                </div>

                <!-- Entrada Manual -->
                <div id="manualInput">
                    <h3 class="section-title">Puntos de Interpolaci√≥n</h3>
                    <p class="input-help">Ingrese los pares de puntos (x, y) que desea interpolar. El orden S√ç afecta la tabla de diferencias (pero no el resultado final simplificado).</p>
                    
                    <div id="pointsContainer"></div>
                    
                    <div style="margin: 15px 0;">
                        <button class="btn btn-primary btn-small" onclick="addPoint()">‚ûï Agregar Punto</button>
                        <button class="btn btn-warning btn-small" onclick="removeLastPoint()">‚ûñ Eliminar √öltimo</button>
                        <button class="btn btn-success btn-small" onclick="loadExamplePoints()">üìù Cargar Ejemplo</button>
                    </div>
                </div>

                <!-- Entrada desde Funci√≥n -->
                <div id="functionInput" style="display: none;">
                    <h3 class="section-title">Generar Puntos desde Funci√≥n</h3>
                    
                    <div class="form-group">
                        <label for="sourceFunction">Funci√≥n f(x):</label>
                        <input type="text" id="sourceFunction" value="Math.log(x)" placeholder="Ejemplo: Math.sin(x), x**2, Math.exp(x)">
                        <div class="input-help">Use notaci√≥n JavaScript: x**2, Math.sin(x), Math.cos(x), Math.exp(x), etc.</div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="xStart">Valor inicial de x:</label>
                            <input type="number" id="xStart" step="any" value="1">
                        </div>
                        
                        <div class="form-group">
                            <label for="xEnd">Valor final de x:</label>
                            <input type="number" id="xEnd" step="any" value="5">
                        </div>
                        
                        <div class="form-group">
                            <label for="numPoints">N√∫mero de puntos:</label>
                            <input type="number" id="numPoints" min="2" max="20" value="5">
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="generatePointsFromFunction()">Generar Puntos</button>
                </div>

                <h3 class="section-title" style="margin-top: 30px;">Evaluaci√≥n del Polinomio</h3>
                
                <div class="form-group">
                    <label for="evalPoints">Valores de x para evaluar (separados por comas):</label>
                    <input type="text" id="evalPoints" placeholder="Ejemplo: 1.5, 2.5, 3.5">
                    <div class="input-help">Ingrese los valores de x donde desea evaluar el polinomio interpolador</div>
                </div>

                <button class="btn btn-success btn-block" onclick="calculateNewton()">üî¨ Calcular Interpolaci√≥n</button>
            </div>

            <div id="resultado" class="results-section" style="display: none;">
                <div id="resultado-contenido"></div>
            </div>
        </div>
    </div>

    <!-- Contenedor para Alertas -->
    <div id="alert-container"></div>

    <script>
        // --- Clases de Utilidad (para que sea independiente) ---
        class UI {
            static showAlert(message, className, duration = 3000) {
                const alertContainer = document.getElementById('alert-container');
                if (!alertContainer) {
                    console.warn("Contenedor de alertas 'alert-container' no encontrado.");
                    return;
                }
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${className}`;
                alertDiv.appendChild(document.createTextNode(message));
                
                alertContainer.appendChild(alertDiv);
                
                setTimeout(() => {
                    alertDiv.style.opacity = '0';
                    alertDiv.style.transition = 'opacity 0.5s ease';
                    setTimeout(() => alertDiv.remove(), 500);
                }, duration);
            }
        }

        class MathUtils {
            static evaluateFunction(funcStr, x) {
                try {
                    // Mapeo de funciones comunes de Math
                    const sin = Math.sin;
                    const cos = Math.cos;
                    const tan = Math.tan;
                    const exp = Math.exp;
                    const log = Math.log; // logaritmo natural
                    const log10 = Math.log10;
                    const log2 = Math.log2;
                    const abs = Math.abs;
                    const sqrt = Math.sqrt;
                    const pow = Math.pow;
                    
                    // Asegurar que 'x' se reemplace correctamente incluso si est√° pegado a un n√∫mero
                    funcStr = funcStr.replace(/(\d+)(x)/g, '$1 * $2'); 
                    
                    // Evaluar la expresi√≥n
                    return new Function('x', 'sin', 'cos', 'tan', 'exp', 'log', 'log10', 'log2', 'abs', 'sqrt', 'pow', `return ${funcStr}`)(x, sin, cos, tan, exp, log, log10, log2, abs, sqrt, pow);
                } catch (e) {
                    console.error("Error evaluating function:", e);
                    throw new Error(`Error en la sintaxis de la funci√≥n: ${funcStr}`);
                }
            }

            static formatNumber(num, digits) {
                if (Math.abs(num) < 1e-10) num = 0;
                // Usar toFixed para redondear y parseFloat para quitar ceros innecesarios
                return parseFloat(num.toFixed(digits));
            }
        }

        class Validators {
            static isValidFunction(funcStr) {
                try {
                    MathUtils.evaluateFunction(funcStr, 1); // Probar con x=1
                    return true;
                } catch (e) {
                    return false;
                }
            }
        }

        class FormValidation {
            static setupFunctionValidation(elementId) {
                const input = document.getElementById(elementId);
                if (input) {
                    input.addEventListener('blur', (e) => {
                        if (e.target.value && !Validators.isValidFunction(e.target.value)) {
                            e.target.style.borderColor = 'red';
                            UI.showAlert('Funci√≥n inv√°lida. Revise la sintaxis.', 'error', 2000);
                        } else {
                            e.target.style.borderColor = '#ccc';
                        }
                    });
                }
            }
            static setupNumericValidation(elementId, rules = {}) {
                // Implementaci√≥n simple (se puede expandir)
            }
        }
        
        // --- L√≥gica de la Aplicaci√≥n ---
        
        let pointCount = 0; // Se inicializar√° en loadExamplePoints

        function toggleInputMethod() {
            const method = document.getElementById('inputMethod').value;
            const manualDiv = document.getElementById('manualInput');
            const functionDiv = document.getElementById('functionInput');
            
            if (method === 'manual') {
                manualDiv.style.display = 'block';
                functionDiv.style.display = 'none';
            } else {
                manualDiv.style.display = 'none';
                functionDiv.style.display = 'block';
            }
        }

        // Esta funci√≥n ahora se usa para a√±adir filas din√°micamente
        function addPointRow(index, xVal = 0, yVal = 0) {
            const container = document.getElementById('pointsContainer');
            const row = document.createElement('div');
            row.className = 'point-input-row';
            row.id = `point-row-${index}`;
            
            row.innerHTML = `
                <div class="form-group">
                    <label for="x${index}">x${index}:</label>
                    <input type="number" id="x${index}" step="any" value="${xVal}" placeholder="Valor de x">
                </div>
                <div class="form-group">
                    <label for="y${index}">y${index} = f(x${index}):</label>
                    <input type="number" id="y${index}" step="any" value="${yVal}" placeholder="Valor de f(x)">
                </div>
                <button class="btn btn-warning btn-small" onclick="removePoint(${index})" title="Eliminar este punto">üóëÔ∏è</button>
            `;
            
            container.appendChild(row);
        }

        function initializePoints() {
            // Cargar el ejemplo por defecto al iniciar
            loadExamplePoints();
        }

        function addPoint() {
            // A√±adir un punto vac√≠o al final
            addPointRow(pointCount, pointCount + 1, 0); // Pass index, default x, default y
            pointCount++;
            UI.showAlert("Punto agregado.", "success", 2000);
        }

        function removePoint(index) {
            const row = document.getElementById(`point-row-${index}`);
            if (row) {
                row.remove();
                UI.showAlert("Punto eliminado.", "info", 2000);
                // Nota: Esto puede desincronizar pointCount si se borra del medio,
                // pero getPoints() es robusto y lee las filas existentes.
                // Para removeLastPoint, re-calculamos pointCount.
                pointCount = document.getElementById('pointsContainer').querySelectorAll('.point-input-row').length;
            }
        }

        function removeLastPoint() {
            const container = document.getElementById('pointsContainer');
            const rows = container.querySelectorAll('.point-input-row');
            
            if (rows.length <= 2) {
                UI.showAlert("Debe haber al menos 2 puntos para la interpolaci√≥n.", "warning");
                return;
            }
            
            const lastRow = rows[rows.length - 1];
            if (lastRow) {
                lastRow.remove();
                pointCount = rows.length - 1;
                UI.showAlert("√öltimo punto eliminado.", "info", 2000);
            }
        }

        // --- ACTUALIZACI√ìN ---
        // Nuevo ejemplo de puntos (un c√∫bico simple)
        function loadExamplePoints() {
            const container = document.getElementById('pointsContainer');
            container.innerHTML = ''; // Limpiar contenedor
            
            // Puntos de f(x) = x^3 - 2x^2 + 3x - 1
            const examplePoints = [
                { x: 0, y: -1 },
                { x: 1, y: 1 },
                { x: 2, y: 5 },
                { x: 3, y: 17 }
            ];
            
            pointCount = 0; // Resetear contador

            examplePoints.forEach((point, i) => {
                // Usar 'i' como el √≠ndice para el ID de la fila
                addPointRow(i, point.x, point.y);
                pointCount++; // Asegurarse que pointCount refleje el n√∫mero total
            });
            
            UI.showAlert("Nuevo ejemplo cargado: f(x) = x^3 - 2x^2 + 3x - 1", "info");
        }
        // --- FIN DE ACTUALIZACI√ìN ---

        function generatePointsFromFunction() {
            const funcStr = document.getElementById('sourceFunction').value.trim();
            const xStart = parseFloat(document.getElementById('xStart').value);
            const xEnd = parseFloat(document.getElementById('xEnd').value);
            const numPoints = parseInt(document.getElementById('numPoints').value);
            
            if (!funcStr) {
                UI.showAlert("Ingrese una funci√≥n v√°lida.", "error");
                return;
            }
            
            if (isNaN(xStart) || isNaN(xEnd) || xStart >= xEnd) {
                UI.showAlert("Los valores inicial y final de x deben ser v√°lidos y xStart < xEnd.", "error");
                return;
            }
            
            if (isNaN(numPoints) || numPoints < 2 || numPoints > 20) {
                UI.showAlert("El n√∫mero de puntos debe estar entre 2 y 20.", "error");
                return;
            }
            
            try {
                if (!Validators.isValidFunction(funcStr)) {
                    UI.showAlert("La funci√≥n no es v√°lida. Revise la sintaxis.", "error");
                    return;
                }
                
                const container = document.getElementById('pointsContainer');
                container.innerHTML = '';
                pointCount = 0;
                
                const step = (xEnd - xStart) / (numPoints - 1);
                
                for (let i = 0; i < numPoints; i++) {
                    const x = (i === numPoints - 1) ? xEnd : (xStart + (i * step)); // Asegurar que el √∫ltimo punto sea exacto
                    const y = MathUtils.evaluateFunction(funcStr, x);
                    
                    if (isNaN(y) || !isFinite(y)) {
                        throw new Error(`La funci√≥n no est√° definida en x=${x} (resultado: ${y})`);
                    }

                    addPointRow(i, x, y);
                    pointCount++;
                }
                
                document.getElementById('inputMethod').value = 'manual';
                toggleInputMethod();
                
                UI.showAlert(`${numPoints} puntos generados exitosamente desde f(x) = ${funcStr}`, "success");
                
            } catch (e) {
                UI.showAlert("Error al generar puntos: " + e.message, "error");
            }
        }

        function getPoints() {
            const points = [];
            const container = document.getElementById('pointsContainer');
            const rows = container.querySelectorAll('.point-input-row');
            
            rows.forEach((row, index) => {
                const xInput = row.querySelector(`input[id^="x"]`);
                const yInput = row.querySelector(`input[id^="y"]`);
                
                if (xInput && yInput) {
                    const x = parseFloat(xInput.value);
                    const y = parseFloat(yInput.value);
                    
                    if (!isNaN(x) && !isNaN(y)) {
                        points.push({ x, y });
                    }
                }
            });
            
            return points;
        }

        class NewtonDividedDifferences {
            constructor(points) {
                this.points = points;
                this.n = points.length;
                this.differencesTable = [];
                this.coefficients = [];
                this.simplifiedCoefficients = []; // Almacenar√° los coeficientes simplificados
            }

            // Calcular tabla de diferencias divididas
            calculateDividedDifferences() {
                const n = this.n;
                
                // Inicializar tabla con primera columna (valores de y)
                this.differencesTable = Array(n).fill(0).map(() => Array(n).fill(null));
                
                for (let i = 0; i < n; i++) {
                    this.differencesTable[i][0] = this.points[i].y;
                }
                
                // Calcular diferencias divididas
                for (let j = 1; j < n; j++) { // j = Columna (Orden de la diferencia)
                    for (let i = 0; i < n - j; i++) { // i = Fila
                        const numerator = this.differencesTable[i + 1][j - 1] - this.differencesTable[i][j - 1];
                        const denominator = this.points[i + j].x - this.points[i].x;
                        
                        if (Math.abs(denominator) < 1e-10) {
                            throw new Error("Divisi√≥n por cero en la tabla de diferencias. Aseg√∫rese de que todos los valores de x sean √∫nicos.");
                        }

                        this.differencesTable[i][j] = numerator / denominator;
                    }
                }
                
                // Extraer coeficientes (diagonal principal)
                this.coefficients = [];
                for (let i = 0; i < n; i++) {
                    this.coefficients.push(this.differencesTable[0][i]);
                }
                
                return this.differencesTable;
            }

            // Evaluar polinomio en un punto x usando forma de Newton
            evaluate(x) {
                let result = this.coefficients[0];
                let term = 1;
                
                for (let i = 1; i < this.n; i++) {
                    term *= (x - this.points[i - 1].x);
                    result += this.coefficients[i] * term;
                }
                
                return result;
            }

            // Generar expresi√≥n en forma de Newton
            getNewtonForm() {
                let expression = `P(x) = ${MathUtils.formatNumber(this.coefficients[0], 6)}`;
                
                for (let i = 1; i < this.n; i++) {
                    const coeff = this.coefficients[i];
                    const sign = coeff >= 0 ? ' + ' : ' - ';
                    const absCoeff = Math.abs(coeff);
                    
                    expression += ` ${sign} ${MathUtils.formatNumber(absCoeff, 6)}`;
                    
                    // Construir producto (x - x0)(x - x1)...(x - x_{i-1})
                    for (let j = 0; j < i; j++) {
                        const xj = this.points[j].x;
                        const xTerm = (xj >= 0) ? `(x - ${MathUtils.formatNumber(xj, 4)})` : `(x + ${MathUtils.formatNumber(Math.abs(xj), 4)})`;
                        expression += xTerm;
                    }
                }
                
                return expression;
            }

            // Evaluar m√∫ltiples puntos
            evaluateMultiple(xValues) {
                return xValues.map(x => ({
                    x: x,
                    y: this.evaluate(x)
                }));
            }
            
            // --- NUEVAS FUNCIONES PARA SIMPLIFICAR ---

            // Suma dos polinomios (arrays de coeficientes)
            // p1 = [c0, c1, c2], p2 = [d0, d1]
            polyAdd(p1, p2) {
                const n = Math.max(p1.length, p2.length);
                const result = new Array(n).fill(0);
                for (let i = 0; i < n; i++) {
                    result[i] = (p1[i] || 0) + (p2[i] || 0);
                }
                return result;
            }

            // Multiplica dos polinomios (arrays de coeficientes)
            polyMultiply(p1, p2) {
                const n = p1.length;
                const m = p2.length;
                const result = new Array(n + m - 1).fill(0);
                for (let i = 0; i < n; i++) {
                    for (let j = 0; j < m; j++) {
                        result[i + j] += p1[i] * p2[j];
                    }
                }
                return result;
            }

            // Calcula el polinomio simplificado
            getSimplifiedPolynomial() {
                // b_i = this.coefficients[i]
                // x_i = this.points[i].x
                
                // P(x) = b0
                let finalPoly = [this.coefficients[0]]; 
                
                // termPoly = (x-x0)(x-x1)...
                let termPoly = [1]; // Representa el polinomio '1'
                
                for (let i = 1; i < this.n; i++) {
                    // 1. Actualizar termPoly: termPoly = termPoly * (x - x_{i-1})
                    // (x - x_{i-1}) se representa como [-x_{i-1}, 1]
                    const factorPoly = [-this.points[i-1].x, 1]; 
                    termPoly = this.polyMultiply(termPoly, factorPoly);
                    
                    // 2. Multiplicar por el escalar b_i
                    const scaledTerm = termPoly.map(c => c * this.coefficients[i]);
                    
                    // 3. A√±adir al polinomio final
                    finalPoly = this.polyAdd(finalPoly, scaledTerm);
                }
                
                this.simplifiedCoefficients = finalPoly;
                return finalPoly;
            }

            // Formatea el array de coeficientes [c0, c1, c2] a "c2x^2 + c1x + c0"
            formatSimplifiedPolynomial(coeffs) {
                if (coeffs.length === 0) return "0";
                
                let parts = [];
                // Iterar desde la potencia m√°s alta
                for (let i = coeffs.length - 1; i >= 0; i--) {
                    let coeff = coeffs[i];
                    
                    // Omitir t√©rminos con coeficiente cero
                    if (Math.abs(coeff) < 1e-10) continue;
                    
                    let sign = (coeff > 0) ? " + " : " - ";
                    let absCoeff = Math.abs(coeff);
                    
                    // Si es el primer t√©rmino y es positivo, no mostrar el signo
                    if (parts.length === 0 && coeff > 0) {
                        sign = "";
                    }
                    
                    let coeffStr;
                    // No mostrar '1' si no es el t√©rmino constante
                    if (Math.abs(absCoeff - 1) < 1e-10 && i > 0) {
                        coeffStr = sign;
                    } else {
                        coeffStr = `${sign}${MathUtils.formatNumber(absCoeff, 6)}`;
                    }

                    let termStr = "";
                    if (i === 0) {
                        termStr = `${sign}${MathUtils.formatNumber(absCoeff, 6)}`; // T√©rmino constante
                    } else if (i === 1) {
                        termStr = `${coeffStr}x`; // T√©rmino x
                    } else {
                        termStr = `${coeffStr}x^${i}`; // T√©rmino x^i
                    }
                    
                    parts.push(termStr);
                }
                
                if (parts.length === 0) return "0";
                // Unir todo y quitar espacios al inicio si el primer t√©rmino es negativo
                return parts.join(" ").trim().replace(/^\+ /, '');
            }
            // --- FIN DE NUEVAS FUNCIONES ---
        }

        function calculateNewton() {
            try {
                const points = getPoints();
                
                if (points.length < 2) {
                    UI.showAlert("Se necesitan al menos 2 puntos para realizar la interpolaci√≥n.", "error");
                    return;
                }
                
                // Verificar que no haya puntos x repetidos
                const xValues = points.map(p => p.x);
                const uniqueX = new Set(xValues);
                if (uniqueX.size !== xValues.length) {
                    UI.showAlert("No puede haber valores de x repetidos.", "error");
                    return;
                }
                
                // No ordenar los puntos
                // points.sort((a, b) => a.x - b.x);
                
                
                // Crear interpolador
                const interpolator = new NewtonDividedDifferences(points);
                interpolator.calculateDividedDifferences();
                
                // --- ACTUALIZACI√ìN ---
                // Calcular el polinomio simplificado
                const simplifiedCoeffs = interpolator.getSimplifiedPolynomial();
                // --- FIN DE ACTUALIZACI√ìN ---
                
                // Obtener puntos de evaluaci√≥n
                const evalInput = document.getElementById('evalPoints').value.trim();
                let evaluations = [];
                
                if (evalInput) {
                    const evalX = evalInput.split(',').map(s => parseFloat(s.trim())).filter(x => !isNaN(x));
                    evaluations = interpolator.evaluateMultiple(evalX);
                }
                
                // --- ACTUALIZACI√ìN ---
                // Pasar los coeficientes simplificados al display
                displayResults(points, interpolator, evaluations, simplifiedCoeffs);
                // --- FIN DE ACTUALIZACI√ìN ---
                
            } catch (e) {
                UI.showAlert("Error al calcular: " + e.message, "error");
                console.error(e);
            }
        }

        // --- ACTUALIZACI√ìN ---
        // Se ha a√±adido 'simplifiedCoeffs' como par√°metro
        function displayResults(points, interpolator, evaluations, simplifiedCoeffs) {
            // --- FIN DE ACTUALIZACI√ìN ---
            
            let html = `<div class="result-summary">
                <h3>üìä Interpolaci√≥n por Diferencias Divididas de Newton</h3>
                <p><strong>Grado del polinomio:</strong> ${points.length - 1}</p>
                <p><strong>N√∫mero de puntos:</strong> ${points.length}</p>
                <p><strong>Puntos de interpolaci√≥n (en el orden usado):</strong></p>
                <div style="margin: 10px 0;">`;
            
            points.forEach((p, i) => {
                html += `<span class="point-badge">(${MathUtils.formatNumber(p.x, 4)}, ${MathUtils.formatNumber(p.y, 4)})</span>`;
            });
            
            html += `</div></div>`;

            // Tabla de diferencias divididas
            html += `<div class="differences-table">
                <h3 style="color: var(--primary-color); margin-bottom: 15px;">üìã Tabla de Diferencias Divididas</h3>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>i</th>
                                <th>x<sub>i</sub></th>
                                <th>f[x<sub>i</sub>] (Orden 0)</th>`;
            
            for (let j = 1; j < points.length; j++) {
                html += `<th>Orden ${j}</th>`;
            }
            
            html += `</tr></thead><tbody>`;
            
            const table = interpolator.differencesTable;
            for (let i = 0; i < points.length; i++) {
                html += `<tr>
                    <td><strong>${i}</strong></td>
                    <td>${MathUtils.formatNumber(points[i].x, 4)}</td>`;
                
                // Rellenar las celdas de la tabla de diferencias (forma triangular)
                for (let j = 0; j < points.length - i; j++) {
                    if (table[i][j] !== null) {
                        const isCoeff = (i === 0);
                        const cellClass = isCoeff ? 'diagonal-highlight' : '';
                        html += `<td class="${cellClass}">${MathUtils.formatNumber(table[i][j], 8)}</td>`;
                    }
                }
                // Rellenar las celdas vac√≠as al final de la fila
                for (let k = 0; k < i; k++) {
                     html += `<td></td>`;
                }

                html += `</tr>`;
            }
            
            html += `</tbody></table></div>
                <p style="margin-top: 15px; color: var(--text-secondary); font-size: 0.9rem;">
                    <strong>Nota:</strong> Los valores resaltados en la primera fila (la diagonal) son los coeficientes b<sub>i</sub> del polinomio.
                </p>
            </div>`;

            // Coeficientes
            html += `<div class="result-card">
                <h3>üî¢ Coeficientes del Polinomio de Newton</h3>
                <p>Los coeficientes b<sub>i</sub> = f[x<sub>0</sub>, x<sub>1</sub>, ..., x<sub>i</sub>] son:</p>
                <div style="margin: 15px 0;">`;
            
            interpolator.coefficients.forEach((coeff, i) => {
                html += `<span class="coefficient-badge">b${i} = ${coeff.toFixed(8)}</span>`;
            });
            
            html += `</div></div>`;

            // Forma de Newton
            html += `<div class="newton-form">
                <h4 style="margin-top: 0; font-size: 1.3rem;">üî¢ POLINOMIO DE NEWTON</h4>
                <div style="font-size: 1rem; margin-top: 15px; line-height: 2;">${interpolator.getNewtonForm()}</div>
            </div>`;

            // --- NUEVO BLOQUE: POLINOMIO SIMPLIFICADO ---
            const simplifiedPolyString = interpolator.formatSimplifiedPolynomial(simplifiedCoeffs);
            html += `<div class="simplified-poly">
                        <h4 style="margin-top: 0; font-size: 1.3rem;">‚úÖ POLINOMIO SIMPLIFICADO (FORMA EST√ÅNDAR)</h4>
                        <p style="font-size: 1.2rem; margin-top: 15px;">P(x) = ${simplifiedPolyString}</p>
                     </div>`;
            // --- FIN DE NUEVO BLOQUE ---

            // Tabla de verificaci√≥n
            html += `<div class="result-card">
                <h3>‚úÖ Verificaci√≥n en los Puntos de Interpolaci√≥n</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Punto</th>
                                <th>x<sub>i</sub></th>
                                <th>y<sub>i</sub> (dado)</th>
                                <th>P(x<sub>i</sub>) (calculado)</th>
                                <th>Error Absoluto</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            points.forEach((p, i) => {
                const calculated = interpolator.evaluate(p.x);
                const error = Math.abs(p.y - calculated);
                html += `<tr>
                    <td>${i}</td>
                    <td>${MathUtils.formatNumber(p.x, 6)}</td>
                    <td>${MathUtils.formatNumber(p.y, 6)}</td>
                    <td>${MathUtils.formatNumber(calculated, 6)}</td>
                    <td>${error.toExponential(2)}</td>
                </tr>`;
            });
            
            html += `</tbody></table></div></div>`;

            // Evaluaciones solicitadas
            if (evaluations.length > 0) {
                html += `<div class="evaluation-section">
                    <h3>üéØ Evaluaciones del Polinomio</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>x</th>
                                    <th>P(x)</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                evaluations.forEach(eval => {
                    html += `<tr>
                        <td>${MathUtils.formatNumber(eval.x, 6)}</td>
                        <td>${MathUtils.formatNumber(eval.y, 6)}</td>
                    </tr>`;
                });
                
                html += `</tbody></table></div></div>`;
            }

            // F√≥rmula general
            html += `<div class="result-card">
                <h3>üìö F√≥rmula General de Newton</h3>
                <div class="polynomial-display" style="background: linear-gradient(135deg, #2c3e50, #34495e);">
                    <p style="margin: 0;">P(x) = b<sub>0</sub> + b<sub>1</sub>(x-x‚ÇÄ) + b<sub>2</sub>(x-x‚ÇÄ)(x-x‚ÇÅ) + ...</p>
                    <p style="margin: 15px 0 0 0; font-size: 0.9rem;">donde b<sub>i</sub> = f[x<sub>0</sub>, ..., x<sub>i</sub>]</p>
                    <p style="margin: 5px 0 0 0;">f[x<sub>i</sub>, ..., x<sub>j</sub>] = (f[x<sub>i+1</sub>, ..., x<sub>j</sub>] - f[x<sub>i</sub>, ..., x<sub>j-1</sub>]) / (x<sub>j</sub> - x<sub>i</sub>)</p>
                </div>
            </div>`;

            document.getElementById("resultado-contenido").innerHTML = html;
            document.getElementById("resultado").style.display = "block";
            
            UI.showAlert("Interpolaci√≥n por Diferencias Divididas calculada exitosamente.", "success");
        }

        // Inicializar al cargar
        window.addEventListener('DOMContentLoaded', function() {
            initializePoints();
            
            FormValidation.setupFunctionValidation('sourceFunction');
            FormValidation.setupNumericValidation('xStart', { required: true });
            FormValidation.setupNumericValidation('xEnd', { required: true });
            FormValidation.setupNumericValidation('numPoints', { min: 2, max: 20, required: true });
        });
    </script>
</body>
</html>

