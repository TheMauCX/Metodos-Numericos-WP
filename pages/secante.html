<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√©todo de la Secante - M√©todos Num√©ricos</title>
    <link rel="stylesheet" href="../assets/css/styles.css">
</head>
<body>
    <a href="../index.html" class="back-button">‚Üê Volver al Inicio</a>
    
    <div class="container">
        <div class="page-container">
            <h1 class="page-title">M√©todo de la Secante</h1>
            <p class="subtitle">Aproximaci√≥n de ra√≠ces sin necesidad de derivadas</p>

            <div class="form-section">
                <h2 class="section-title">Par√°metros de Entrada</h2>
                
                <div class="form-group">
                    <label for="funcion">Funci√≥n f(x):</label>
                    <input type="text" id="funcion" value="x**2 - 4" placeholder="Ejemplo: x**2 - 4">
                    <div class="input-help">Use notaci√≥n JavaScript: x**2, Math.sin(x), Math.cos(x), Math.exp(x), etc.</div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="x0">Valor inicial x‚ÇÄ:</label>
                        <input type="number" id="x0" step="any" value="6">
                    </div>
                    
                    <div class="form-group">
                        <label for="x1">Valor inicial x‚ÇÅ:</label>
                        <input type="number" id="x1" step="any" value="7">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="tolerance">Error deseado (%):</label>
                        <input type="number" id="tolerance" step="0.0001" value="0.01" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="maxIterations">N√∫mero m√°ximo de iteraciones:</label>
                        <input type="number" id="maxIterations" value="10" min="1">
                    </div>
                </div>

                <button class="btn btn-primary btn-block" onclick="calcular()">Calcular Ra√≠z</button>
            </div>

            <div id="resultado" class="results-section" style="display: none;">
                <h2 class="section-title">Resultados</h2>
                <div id="resultado-contenido"></div>
            </div>
        </div>
    </div>

    <script src="../assets/js/common.js"></script>
    <script>
        function secante(funcion, x0, x1, tolerancia, maxIteraciones) {
            let resultados = [];
            let xPrev = x0;
            let xCurr = x1;
            
            for (let i = 0; i < maxIteraciones; i++) {
                const fPrev = MathUtils.evaluateFunction(funcion, xPrev);
                const fCurr = MathUtils.evaluateFunction(funcion, xCurr);
                
                // Verificar divisi√≥n por cero
                if (Math.abs(fCurr - fPrev) < 1e-10) {
                    throw new Error("Divisi√≥n por cero o diferencia muy peque√±a entre f(x·µ¢) y f(x·µ¢‚Çã‚ÇÅ).");
                }
                
                // Calcular siguiente aproximaci√≥n
                const xNext = xCurr - (fCurr * (xPrev - xCurr)) / (fPrev - fCurr);
                const fNext = MathUtils.evaluateFunction(funcion, xNext);
                
                // Calcular error aproximado
                const error = i === 0 ? 999 : MathUtils.calculateError(xNext, xCurr);
                
                resultados.push({
                    iteracion: i + 1,
                    xPrev: xPrev,
                    xCurr: xCurr,
                    xNext: xNext,
                    fPrev: fPrev,
                    fCurr: fCurr,
                    fNext: fNext,
                    error: error
                });
                
                // Verificar convergencia
                if (error < tolerancia && i > 0) {
                    return { resultados, raiz: xNext };
                }
                
                // Preparar siguiente iteraci√≥n
                xPrev = xCurr;
                xCurr = xNext;
            }
            
            return { resultados, raiz: xCurr };
        }

        function calcular() {
            const funcion = document.getElementById("funcion").value.trim();
            const x0 = parseFloat(document.getElementById("x0").value);
            const x1 = parseFloat(document.getElementById("x1").value);
            const tolerancia = parseFloat(document.getElementById("tolerance").value);
            const maxIteraciones = parseInt(document.getElementById("maxIterations").value);

            // Validaciones
            if (!funcion) {
                UI.showAlert("Por favor, ingrese una funci√≥n v√°lida.", "error");
                return;
            }

            if (isNaN(x0) || isNaN(x1)) {
                UI.showAlert("Por favor, ingrese valores iniciales v√°lidos.", "error");
                return;
            }

            if (isNaN(tolerancia) || tolerancia <= 0) {
                UI.showAlert("El error deseado debe ser un n√∫mero positivo.", "error");
                return;
            }

            if (isNaN(maxIteraciones) || maxIteraciones <= 0) {
                UI.showAlert("El n√∫mero de iteraciones debe ser un entero positivo.", "error");
                return;
            }

            try {
                // Validar funci√≥n
                if (!Validators.isValidFunction(funcion)) {
                    UI.showAlert("La funci√≥n no es v√°lida. Revise la sintaxis.", "error");
                    return;
                }

                const { resultados, raiz } = secante(funcion, x0, x1, tolerancia, maxIteraciones);

                let html = `<div class="result-summary">
                    <h3>üìä Resumen del C√°lculo</h3>
                    <p><strong>Funci√≥n:</strong> f(x) = ${funcion}</p>
                    <p><strong>Valores iniciales:</strong> x‚ÇÄ = ${x0}, x‚ÇÅ = ${x1}</p>
                    <p><strong>Ra√≠z aproximada:</strong> x = ${MathUtils.formatNumber(raiz)}</p>
                    <p><strong>Verificaci√≥n:</strong> f(${MathUtils.formatNumber(raiz)}) = ${MathUtils.formatNumber(MathUtils.evaluateFunction(funcion, raiz))}</p>
                    <p><strong>Iteraciones realizadas:</strong> ${resultados.length}</p>
                </div>`;

                // Generar tabla manualmente
                html += `<div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Iteraci√≥n</th>
                                <th>x·µ¢‚Çã‚ÇÅ</th>
                                <th>x·µ¢</th>
                                <th>x·µ¢‚Çä‚ÇÅ</th>
                                <th>f(x·µ¢‚Çã‚ÇÅ)</th>
                                <th>f(x·µ¢)</th>
                                <th>f(x·µ¢‚Çä‚ÇÅ)</th>
                                <th>Error (%)</th>
                            </tr>
                        </thead>
                        <tbody>`;

                resultados.forEach(r => {
                    html += `<tr>
                        <td>${r.iteracion}</td>
                        <td>${MathUtils.formatNumber(r.xPrev)}</td>
                        <td>${MathUtils.formatNumber(r.xCurr)}</td>
                        <td>${MathUtils.formatNumber(r.xNext)}</td>
                        <td>${MathUtils.formatNumber(r.fPrev)}</td>
                        <td>${MathUtils.formatNumber(r.fCurr)}</td>
                        <td>${MathUtils.formatNumber(r.fNext)}</td>
                        <td>${r.error === 999 ? '-' : MathUtils.formatNumber(r.error)}</td>
                    </tr>`;
                });

                html += `</tbody></table></div>`;

                document.getElementById("resultado-contenido").innerHTML = html;
                document.getElementById("resultado").style.display = "block";
                
                UI.showAlert("C√°lculo completado exitosamente.", "success");

            } catch (e) {
                UI.showAlert(e.message, "error");
                UI.hideResults("resultado");
            }
        }

        // Configuraci√≥n de validaci√≥n en tiempo real
        document.addEventListener('DOMContentLoaded', function() {
            FormValidation.setupFunctionValidation('funcion');
            FormValidation.setupNumericValidation('x0', { required: true });
            FormValidation.setupNumericValidation('x1', { required: true });
            FormValidation.setupNumericValidation('tolerance', { min: 0, positive: true, required: true });
            FormValidation.setupNumericValidation('maxIterations', { min: 1, required: true });
        });
    </script>
</body>
</html>