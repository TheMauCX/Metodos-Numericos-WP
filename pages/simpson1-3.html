<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regla de Simpson 1/3 - M√©todos Num√©ricos</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      }
    };
    </script>
    <script id="MathJax-script" async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
    
    <link rel="stylesheet" href="../assets/css/styles.css">
    <style>
        #functionChart {
            max-height: 400px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <a href="../index.html" class="back-button">‚Üê Volver al Inicio</a>
    
    <div class="container">
        <div class="page-container">
            <h1 class="page-title">Regla de Simpson 1/3</h1>
            <p class="subtitle">Aproxima una integral definida $I = \int_{a}^{b} f(x) \,dx$ usando la regla de Simpson 1/3 compuesta.</p>
            
            <div class="result-card" style="background-color: #f8f9fa;">
                <h3 class="section-title" style="margin-bottom: 15px; border: none;">F√≥rmulas Clave</h3>
                <p><strong>F√≥rmula de Simpson 1/3 Compuesta (requiere $n$ par):</strong></p>
                <p style="text-align: center; font-size: 1.1rem; margin-top: 10px;">
                    $$ I \approx \frac{h}{3} \left[ f(x_0) + 4 \sum_{i=1, 3, ...}^{n-1} f(x_i) + 2 \sum_{i=2, 4, ...}^{n-2} f(x_i) + f(x_n) \right] $$
                </p>
                <p><strong>Cota de Error ($E_S$):</strong></p>
                <p style="text-align: center; font-size: 1.1rem; margin-top: 10px;">
                    $$ |E_S| \le \frac{M(b-a)^5}{180n^4} \quad \text{donde } M \ge |f^{(4)}(x)| \text{ en } [a, b] $$
                </p>
                <p>Donde $h = \frac{b-a}{n}$ y $n$ debe ser par.</p>
            </div>
            <div class="form-section">
                <h2 class="section-title">Par√°metros de Entrada</h2>
                
                <div class="form-group">
                    <label for="funcion">Funci√≥n $f(x)$:</label>
                    <input type="text" id="funcion" value="1/(1 + x**2)" placeholder="Ejemplo: x**2, Math.sin(x)">
                    <div class="input-help">Use notaci√≥n JavaScript: x**2, Math.sin(x), Math.cos(x), Math.exp(x), etc.</div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="limiteA">L√≠mite inferior ($a$):</label>
                        <input type="number" id="limiteA" step="any" value="0">
                    </div>
                    <div class="form-group">
                        <label for="limiteB">L√≠mite superior ($b$):</label>
                        <input type="number" id="limiteB" step="any" value="1">
                    </div>
                </div>

                <div class="form-group">
                    <label for="intervalos">N√∫mero de intervalos ($n$):</label>
                    <input type="number" id="intervalos" value="10" min="2" step="2">
                    <div class="input-help">Debe ser un entero <strong>par</strong> positivo ($n \ge 2$).</div>
                </div>
                
                <div class="form-group">
                    <label for="valorM">Valor M√°ximo de $|f^{(4)}(x)|$ ($M$):</label>
                    <input type="number" id="valorM" step="any" placeholder="Opcional: para calcular el error">
                    <div class="input-help">Ingrese el valor m√°ximo de la 4ta derivada en $[a, b]$ para estimar el error.</div>
                </div>

                <button class="btn btn-primary btn-block" onclick="calcular()">Calcular Integral</button>
            </div>

            <div id="resultado" class="results-section" style="display: none;">
                <h2 class="section-title">Resultados</h2>
                <div id="resultado-contenido"></div>
            </div>
        </div>
    </div>

    <script src="../assets/js/common.js"></script>
    <script>
        let chartInstance = null;

        function calcular() {
            const funcion = document.getElementById("funcion").value.trim();
            const a = parseFloat(document.getElementById("limiteA").value);
            const b = parseFloat(document.getElementById("limiteB").value);
            const n = parseInt(document.getElementById("intervalos").value);
            const M = parseFloat(document.getElementById("valorM").value);

            // Validaciones
            if (!funcion) {
                UI.showAlert("Por favor, ingrese una funci√≥n v√°lida.", "error");
                return;
            }
            if (isNaN(a) || isNaN(b) || isNaN(n)) {
                UI.showAlert("Los l√≠mites y el n√∫mero de intervalos deben ser n√∫meros v√°lidos.", "error");
                return;
            }
            if (b <= a) {
                UI.showAlert("El l√≠mite superior (b) debe ser mayor que el l√≠mite inferior (a).", "error");
                return;
            }
            if (n < 2 || !Number.isInteger(n) || n % 2 !== 0) {
                UI.showAlert("El n√∫mero de intervalos (n) debe ser un entero <strong>par</strong> positivo ($n \ge 2$).", "error");
                return;
            }
            try {
                if (!Validators.isValidFunction(funcion, a)) {
                    UI.showAlert("La funci√≥n no es v√°lida o no se puede evaluar en el l√≠mite inferior. Revise la sintaxis.", "error");
                    return;
                }
            } catch (e) {
                 UI.showAlert(e.message, "error");
                 return;
            }

            try {
                const h = (b - a) / n;
                let sum = MathUtils.evaluateFunction(funcion, a) + MathUtils.evaluateFunction(funcion, b);
                let sumOdd = 0;
                let sumEven = 0;
                
                let tableData = [];
                tableData.push({ i: 0, xi: a, fxi: MathUtils.evaluateFunction(funcion, a), termino: '1 ¬∑ f(x‚ÇÄ)' });

                for (let i = 1; i < n; i++) {
                    const xi = a + i * h;
                    const fxi = MathUtils.evaluateFunction(funcion, xi);
                    
                    if (i % 2 === 1) { // Impar
                        sumOdd += fxi;
                        tableData.push({ i: i, xi: xi, fxi: fxi, termino: '4 ¬∑ f(x·µ¢)' });
                    } else { // Par
                        sumEven += fxi;
                        tableData.push({ i: i, xi: xi, fxi: fxi, termino: '2 ¬∑ f(x·µ¢)' });
                    }
                }
                
                tableData.push({ i: n, xi: b, fxi: MathUtils.evaluateFunction(funcion, b), termino: '1 ¬∑ f(x‚Çô)' });

                const integral = (h / 3) * (sum + 4 * sumOdd + 2 * sumEven);

                // C√°lculo de Error
                let errorHtml = "";
                if (!isNaN(M)) {
                    const errorEstimado = (M * Math.pow(b - a, 5)) / (180 * Math.pow(n, 4));
                    errorHtml = `<p><strong>Cota de Error M√°ximo ($E_S$):</strong> ${MathUtils.formatNumber(errorEstimado)}</p>
                                 <p class="input-help">Basado en $M = ${M}$</p>`;
                }

                // --- CAMBIO AQU√ç ---
                // Convertir la funci√≥n JS a LaTeX para mostrarla
                const funcionLatex = MathUtils.jsToLatex(funcion);
                // --- FIN DEL CAMBIO ---

                // Generar HTML de resultados
                let html = `<div class="result-summary">
                    <h3>üìä Resumen del C√°lculo</h3>
                    <p><strong>Funci√≥n:</strong> $f(x) = ${funcionLatex}$</p>
                    <p><strong>Intervalo:</strong> $[${a}, ${b}]$</p>
                    <p><strong>Intervalos ($n$):</strong> ${n} (Requisito: par)</p>
                    <p><strong>Tama√±o de paso ($h$):</strong> ${MathUtils.formatNumber(h, 6)}</p>
                    <p><strong>Resultado de la Integral ($I$):</strong> ${MathUtils.formatNumber(integral)}</p>
                    ${errorHtml}
                </div>`;

                // Gr√°fico
                html += `<div class="result-card">
                    <h3 class="section-title">Gr√°fica de la Funci√≥n</h3>
                    <canvas id="functionChart"></canvas>
                </div>`;

                // Tabla de puntos
                html += `<div class="result-card">
                    <h3 class="section-title">Tabla de Puntos y Coeficientes</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>$i$</th>
                                    <th>$x_i$</th>
                                    <th>$f(x_i)$</th>
                                    <th>T√©rmino en la suma</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                tableData.forEach(r => {
                    html += `<tr>
                        <td>${r.i}</td>
                        <td>${MathUtils.formatNumber(r.xi)}</td>
                        <td>${MathUtils.formatNumber(r.fxi)}</td>
                        <td>${r.termino}</td>
                    </tr>`;
                });
                
                html += `</tbody></table></div></div>`;

                document.getElementById("resultado-contenido").innerHTML = html;
                document.getElementById("resultado").style.display = "block";

                // Renderizar gr√°fico
                plotFunction(funcion, a, b);
                
                // Volver a renderizar MathJax para los nuevos elementos
                if (window.MathJax) {
                    MathJax.typesetPromise();
                }

                UI.showAlert("C√°lculo completado exitosamente.", "success");

            } catch (e) {
                UI.showAlert(e.message, "error");
                UI.hideResults("resultado");
            }
        }
        
        function plotFunction(funcStr, a, b) {
            const ctx = document.getElementById('functionChart').getContext('2d');
            const stepCount = 100; // Puntos para la gr√°fica
            const h = (b - a) / stepCount;
            let labels = [];
            let data = [];

            for (let i = 0; i <= stepCount; i++) {
                const x = a + i * h;
                labels.push(x.toFixed(2));
                data.push(MathUtils.evaluateFunction(funcStr, x));
            }

            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `f(x) = ${funcStr}`,
                        data: data,
                        borderColor: 'var(--secondary-color)',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: { display: true, text: 'x' }
                        },
                        y: {
                            title: { display: true, text: 'f(x)' }
                        }
                    }
                }
            });
        }

        // Configuraci√≥n de validaci√≥n en tiempo real
        document.addEventListener('DOMContentLoaded', function() {
            FormValidation.setupFunctionValidation('funcion');
            FormValidation.setupNumericValidation('limiteA');
            FormValidation.setupNumericValidation('limiteB');
            FormValidation.setupNumericValidation('intervalos', { min: 2, required: true });
        });
    </script>
</body>
</html>